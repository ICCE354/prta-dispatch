<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRTA CAD / MDT System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.page{display:none;padding:20px}
input,select,textarea,button{
  width:100%;padding:8px;margin:5px 0;
  background:#020617;color:#e5e7eb;
  border:1px solid #1f2937;border-radius:6px
}
button{background:#2563eb;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #1f2937;padding:6px;text-align:center}
th{background:#020617}
.late{background:#7f1d1d}
.early{background:#1e3a8a}
.ontime{background:#064e3b}
.msg{border:1px solid #1f2937;padding:6px;margin-bottom:5px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="page">
  <h1>PRTA Secure Login</h1>
  <select id="role">
    <option value="driver">Driver</option>
    <option value="dispatcher">Dispatcher</option>
    <option value="supervisor">Supervisor</option>
  </select>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <input id="busInput" placeholder="Bus ID (drivers only)">
  <label><input type="checkbox" id="pt1"> Brakes OK</label><br>
  <label><input type="checkbox" id="pt2"> Doors OK</label><br>
  <label><input type="checkbox" id="pt3"> Lights OK</label><br><br>
  <button onclick="login()">Login</button>
</div>

<!-- DRIVER -->
<div id="driverPage" class="page">
  <h1>üöç Driver MDT</h1>
  <button onclick="logout()">Logout</button>
  <table id="driverTable"></table>
</div>

<!-- DISPATCHER -->
<div id="dispatcherPage" class="page">
  <h1>üßë‚Äçüíª Dispatcher</h1>
  <button onclick="logout()">Logout</button>
  <table id="boardDispatcher"></table>
</div>

<!-- SUPERVISOR -->
<div id="supervisorPage" class="page">
  <h1>üßë‚Äçüíº Supervisor</h1>
  <button onclick="logout()">Logout</button>
  <table id="boardSupervisor"></table>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* üîä EMBEDDED DRIVER-ONLY AUDIO */
const departSound = new Audio("data:audio/wav;base64,UklGRkbPAwBXQVZFZm10IBAAAAABAAIARKwAABCxAgAEABAATElTVBoAAABJTkZPSVNGVA0AAABMYXZmNjEuMS4xMDAAAGRhdGEA" + 
"{{TRUNCATED_FOR_READABILITY}}");

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAQ0dtJowQk2aPV_laJNJoUZFJQLxEr9u0",
  authDomain:"prta-dispatch.firebaseapp.com",
  projectId:"prta-dispatch"
});
const db=firebase.firestore();

/* USERS */
const users={
  dispatcher:{password:"admin",role:"dispatcher"},
  U11:{password:"BIGT",role:"supervisor"},
  "3675":{password:"SR",role:"driver"}
};

let currentUser={};

/* PAGE CONTROL */
function show(p){
  document.querySelectorAll(".page").forEach(x=>x.style.display="none");
  document.getElementById(p).style.display="block";
}
window.onload=()=>show("loginPage");

/* LOGIN */
async function login(){
  if(!users[username.value]||
     users[username.value].password!==password.value||
     users[username.value].role!==role.value){
    alert("Invalid login"); return;
  }

  if(role.value==="driver"&&(!(pt1.checked&&pt2.checked&&pt3.checked)||!busInput.value)){
    alert("Pre-trip required"); return;
  }

  currentUser={username:username.value,role:role.value};

  if(role.value==="driver"){show("driverPage"); loadDriver();}
  if(role.value==="dispatcher"){show("dispatcherPage"); renderBoard("boardDispatcher");}
  if(role.value==="supervisor"){show("supervisorPage"); renderBoard("boardSupervisor");}
}

/* LOGOUT ‚Äî HARD CLEAR */
async function logout(){
  if(currentUser.role==="driver"){
    const ref=db.collection("schedules").doc(currentUser.username).collection("trips");
    const snap=await ref.get();
    for(const d of snap.docs){await d.ref.delete();}
    await db.collection("schedules").doc(currentUser.username).delete();
  }
  currentUser={};
  renderBoard("boardDispatcher");
  renderBoard("boardSupervisor");
  show("loginPage");
}

/* DRIVER LOAD */
async function loadDriver(){
  const t=document.getElementById("driverTable");
  t.innerHTML="<tr><th>Stop</th><th>Sched</th><th>Status</th></tr>";
  const s=await db.collection("schedules").doc(currentUser.username).collection("trips").get();

  s.forEach(d=>{
    const tr=d.data();
    tr.points.forEach((p,i)=>{
      const now=new Date();
      const [h,m]=p.sched.split(":").map(Number);
      const sched=new Date(); sched.setHours(h,m,0,0);

      /* üîä DRIVER DEPARTURE SOUND */
      if(!p.arrived && !p.alerted && now >= sched){
        departSound.play();
        p.alerted = true;
        db.collection("schedules")
          .doc(currentUser.username)
          .collection("trips")
          .doc(d.id)
          .update({points:tr.points});
      }

      const r=t.insertRow();
      r.insertCell().innerText=p.label;
      r.insertCell().innerText=p.sched;
      r.insertCell().innerHTML=p.arrived
        ? `${p.arrivalStatus} (${p.delta}m)`
        : `<button onclick="arrive('${d.id

