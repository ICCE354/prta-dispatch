<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRTA Transit Operations System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.page{display:none;padding:20px}
input,select,textarea,button{
  width:100%;padding:8px;margin:5px 0;
  background:#020617;color:#e5e7eb;
  border:1px solid #1f2937;border-radius:6px
}
button{background:#2563eb;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #1f2937;padding:6px;text-align:center}
th{background:#020617}
.late{background:#3f1d1d}
.msg{border:1px solid #1f2937;padding:6px;margin-bottom:5px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="page">
  <h1>PRTA Secure Login</h1>
  <select id="role">
    <option value="driver">Driver</option>
    <option value="supervisor">Supervisor</option>
    <option value="dispatcher">Dispatcher</option>
  </select>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <input id="busInput" placeholder="Bus ID (drivers only)">
  <label><input type="checkbox" id="pt1"> Brakes OK</label><br>
  <label><input type="checkbox" id="pt2"> Doors OK</label><br>
  <label><input type="checkbox" id="pt3"> Lights OK</label><br><br>
  <button onclick="login()">Login</button>
</div>

<!-- DRIVER -->
<div id="driverPage" class="page">
  <h1>üöç Driver</h1>
  <button onclick="logout()">Logout</button>
  <h3>üì® Messages</h3>
  <div id="driverMessages"></div>
  <table id="driverTable"></table>
</div>

<!-- SUPERVISOR -->
<div id="supervisorPage" class="page">
  <h1>üßë‚Äçüíº Supervisor</h1>
  <button onclick="logout()">Logout</button>
  <table id="boardSupervisor"></table>
</div>

<!-- DISPATCHER -->
<div id="dispatcherPage" class="page">
  <h1>üßë‚Äçüíª Dispatcher</h1>
  <button onclick="logout()">Logout</button>

  <h3>Schedule Builder</h3>
  <input id="schDriver" placeholder="Driver Username">
  <input id="schBus" placeholder="Bus ID">
  <input id="schRoute" placeholder="Route">
  <input id="schTime" placeholder="HH:MM">
  <textarea id="schPoints" placeholder="Timepoints (use | , max 5)"></textarea>
  <button onclick="createSchedule()">Assign Schedule</button>

  <h3>üìª Dispatch Message</h3>
  <input id="msgDriver" placeholder="Driver Username">
  <textarea id="msgText" placeholder="Message"></textarea>
  <button onclick="sendMessage()">Send Message</button>

  <h3>Live Board</h3>
  <table id="boardDispatcher"></table>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey:"AIzaSyAQ0dtJowQk2aPV_laJNJoUZFJQLxEr9u0",
  authDomain:"prta-dispatch.firebaseapp.com",
  projectId:"prta-dispatch",
  storageBucket:"prta-dispatch.appspot.com",
  messagingSenderId:"1023193983810",
  appId:"1:1023193983810:web:b66f4b577f1e4c32a6fddb"
});
const db=firebase.firestore();

/* USERS */
const users={
  dispatcher:{password:"admin",role:"dispatcher"},
  U11:{password:"BIGT",role:"supervisor"},
  "3675":{password:"SR",role:"driver"},
  "3804":{password:"ER",role:"driver"}
};

let currentUser={loggedIn:false,role:"",username:"",bus:""};

function show(p){
  document.querySelectorAll(".page").forEach(x=>x.style.display="none");
  document.getElementById(p).style.display="block";
}
window.onload=()=>show("loginPage");

/* LOGIN */
async function login(){
  if(!users[username.value]||
     users[username.value].password!==password.value||
     users[username.value].role!==role.value){
    alert("Invalid login");return;
  }

  if(role.value==="driver"&&(!(pt1.checked&&pt2.checked&&pt3.checked)||!busInput.value)){
    alert("Pre-trip required");return;
  }

  currentUser={loggedIn:true,role:role.value,username:username.value,bus:busInput.value};

  if(role.value==="driver"){show("driverPage");loadDriver();loadDriverMessages();}
  if(role.value==="dispatcher"){show("dispatcherPage");renderBoard("boardDispatcher");}
  if(role.value==="supervisor"){show("supervisorPage");renderBoard("boardSupervisor");}
}

/* üî• LOGOUT ‚Äî DELETE ALL DRIVER TRIPS */
async function logout(){
  if(currentUser.loggedIn && currentUser.role==="driver"){
    const d=currentUser.username;
    const trips=await db.collection("schedules").doc(d).collection("trips").get();
    for(const x of trips.docs){await x.ref.delete();}
    await db.collection("schedules").doc(d).delete();
  }
  currentUser={loggedIn:false,role:"",username:"",

