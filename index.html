<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PRTA Dispatch System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.page{display:none;padding:20px}
input,textarea,button{width:100%;padding:8px;margin:6px 0;background:#020617;color:#e5e7eb;border:1px solid #1f2937;border-radius:6px}
button{background:#2563eb;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #1f2937;padding:6px;text-align:center}
th{background:#020617}
.late{background:#7f1d1d}
.early{background:#1e3a8a}
.ontime{background:#064e3b}
.box{border:2px solid #2563eb;padding:12px;margin:12px 0}
.msgPending{background:#7c2d12}
.msgAck{background:#064e3b}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="page" style="display:block">
<h2>PRTA Secure Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<input id="busInput" placeholder="Bus ID (drivers)">
<label><input type="checkbox" id="pt1"> Brakes</label>
<label><input type="checkbox" id="pt2"> Doors</label>
<label><input type="checkbox" id="pt3"> Lights</label>
<button onclick="login()">Login</button>
</div>

<!-- DRIVER -->
<div id="driverPage" class="page">
<h2>Driver MDT</h2>
<button onclick="logout()">Logout</button>

<div class="box">
<h3>Radio Messages</h3>
<button onclick="sendMsg('Running Late')">Running Late</button>
<button onclick="sendMsg('Traffic Delay')">Traffic Delay</button>
<button onclick="sendMsg('Mechanical Issue')">Mechanical Issue</button>
<button onclick="sendMsg('Customer Declined Shoulder Strap')">Customer Declined Shoulder Strap</button>
<button onclick="sendMsg('Operator Assistance Requested')">Operator Assistance Requested</button>
</div>

<table id="driverTable"></table>
</div>

<!-- DISPATCH -->
<div id="dispatcherPage" class="page">
<h2>Dispatcher</h2>
<button onclick="logout()">Logout</button>

<div class="box">
<h3>Create Schedule</h3>
<input id="schDriver" placeholder="Driver">
<input id="schBus" placeholder="Bus">
<textarea id="schPoints" placeholder="StopA 15:30 | StopB 15:45"></textarea>
<button onclick="createSchedule()">Assign</button>
</div>

<h3>Incoming Messages</h3>
<table id="msgTable"></table>

<h3>Live Board</h3>
<table id="dispatchBoard"></table>
</div>

<!-- SUPERVISOR -->
<div id="supervisorPage" class="page">
<h2>Supervisor</h2>
<button onclick="logout()">Logout</button>

<h3>Messages</h3>
<table id="msgTableSup"></table>

<h3>Live Board</h3>
<table id="supervisorBoard"></table>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ðŸ”Š DRIVER-ONLY DEPARTURE SOUND */
const departSound = new Audio("Timetodepart.wav");
let audioUnlocked = false;
document.addEventListener("click",()=>audioUnlocked=true,{once:true});

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAQ0dtJowQk2aPV_laJNJoUZFJQLxEr9u0",
  authDomain:"prta-dispatch.firebaseapp.com",
  projectId:"prta-dispatch"
});
const db=firebase.firestore();

/* USERS */
const users={
  dispatcher:{password:"admin",role:"dispatcher"},
  D01:{password:"DISP1",role:"dispatcher"},
  U11:{password:"BIGT",role:"supervisor"},
  SUP1:{password:"SUP1",role:"supervisor"},
  "3675":{password:"SR",role:"driver"},
  "3804":{password:"ER",role:"driver"}
};

let currentUser={},currentBus="";
let unsubBoard=null;

/* UI */
function show(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
}

/* LOGIN */
function login(){
  const u=username.value.trim(),p=password.value.trim();
  if(!users[u]||users[u].password!==p){alert("Invalid login");return;}
  if(users[u].role==="driver"){
    if(!busInput.value||!(pt1.checked&&pt2.checked&&pt3.checked)){
      alert("Pre-trip required");return;
    }
  }
  currentUser={username:u,role:users[u].role};
  currentBus=busInput.value||"";

  if(currentUser.role==="driver"){show("driverPage");listenDriver();}
  if(currentUser.role==="dispatcher"){show("dispatcherPage");listenBoard("dispatchBoard");listenMessages();}
  if(currentUser.role==="supervisor"){show("supervisorPage");listenBoard("supervisorBoard");listenMessagesSup();}
}

/* LOGOUT */
async function logout(){
  if(unsubBoard)unsubBoard();
  if(currentUser.role==="driver"){
    const ref=db.collection("schedules").doc(currentUser.username);
    const snap=await ref.collection("trips").get();
    snap.forEach(d=>d.ref.delete());
    await ref.delete();
  }
  currentUser={};
  show("loginPage");
}

/* SCHEDULE */
async function createSchedule(){
  const points=schPoints.value.split("|").map(p=>{
    const a=p.trim().split(" ");
    const t=a.pop();
    return{label:a.join(" "),time:t,arrived:false,alerted:false,delta:null,status:null};
  });
  await db.collection("schedules")
    .doc(schDriver.value.trim())
    .collection("trips")
    .add({bus:schBus.value.trim(),points});
  schPoints.value="";
}

/* DRIVER */
function listenDriver(){
  db.collection("schedules").doc(currentUser.username)
    .collection("trips")
    .onSnapshot(snap=>{
      driverTable.innerHTML="<tr><th>Stop</th><th>Sched</th><th>Status</th></tr>";
      snap.forEach(doc=>{
        const trip=doc.data();
        trip.points.forEach((p,i)=>{
          const now=new Date();
          const [h,m]=p.time.split(":").map(Number);
          const sched=new Date();sched.setHours(h,m,0,0);

          /* ðŸ”” PLAY SOUND WHEN TIME TO DEPART (DRIVER ONLY) */
          if(!p.arrived && !p.alerted && now>=sched && audioUnlocked){
            departSound.play().catch(()=>{});
            p.alerted=true;
            doc.ref.update({points:trip.points});
          }

          const r=driverTable.insertRow();
          r.insertCell().innerText=p.label;
          r.insertCell().innerText=p.time;
          r.insertCell().innerHTML=p.arrived
            ?`${p.status} (${p.delta}m)`
            :`<button onclick="arrive('${doc.id}',${i})">Arrived</button>`;
        });
      });
    });
}

async function arrive(id,i){
  const ref=db.collection("schedules").doc(currentUser.username).collection("trips").doc(id);
  const trip=(await ref.get()).data();
  const now=new Date();
  const [h,m]=trip.points[i].time.split(":").map(Number);
  const sched=new Date();sched.setHours(h,m,0,0);
  const diff=Math.round((now-sched)/60000);
  let status="On Time";
  if(diff>=2)status="Late";
  if(diff<=-2)status="Early";
  trip.points[i]={...trip.points[i],arrived:true,delta:Math.abs(diff),status};
  if(trip.points.every(p=>p.arrived))await ref.delete();
  else await ref.update({points:trip.points});
}

/* LIVE BOARD */
function listenBoard(id){
  const t=document.getElementById(id);
  unsubBoard=db.collection("schedules").onSnapshot(async snap=>{
    t.innerHTML="<tr><th>Driver</th><th>Status</th></tr>";
    for(const d of snap.docs){
      const trips=await d.ref.collection("trips").get();
      trips.forEach(tr=>{
        const r=t.insertRow();
        r.insertCell().innerText=d.id;
        r.insertCell().innerText=tr.data().points.map(p=>{
          if(!p.arrived)return"âšª";
          if(p.status==="Late")return`ðŸ”´ +${p.delta}`;
          if(p.status==="Early")return`ðŸ”µ -${p.delta}`;
          return"ðŸŸ¢ 0";
        }).join(" ");
      });
    }
  });
}

/* MESSAGING */
async function sendMsg(text){
  await db.collection("messages").add({
    driver:currentUser.username,
    bus:currentBus,
    text,
    status:"Pending",
    time:new Date().toLocaleTimeString()
  });
}

function listenMessages(){
  db.collection("messages").onSnapshot(snap=>{
    msgTable.innerHTML="<tr><th>Driver</th><th>Bus</th><th>Message</th><th>Status</th></tr>";
    snap.forEach(doc=>{
      const m=doc.data(),r=msgTable.insertRow();
      r.className=m.status==="Pending"?"msgPending":"msgAck";
      r.insertCell().innerText=m.driver;
      r.insertCell().innerText=m.bus;
      r.insertCell().innerText=`${m.text} (${m.time})`;
      r.insertCell().innerHTML=m.status==="Pending"
        ?`<button onclick="db.collection('messages').doc('${doc.id}').update({status:'Acknowledged'})">Ack</button>`
        :"Acknowledged";
    });
  });
}

function listenMessagesSup(){
  db.collection("messages").onSnapshot(snap=>{
    msgTableSup.innerHTML="<tr><th>Driver</th><th>Bus</th><th>Message</th><th>Status</th></tr>";
    snap.forEach(doc=>{
      const m=doc.data(),r=msgTableSup.insertRow();
      r.className=m.status==="Pending"?"msgPending":"msgAck";
      r.insertCell().innerText=m.driver;
      r.insertCell().innerText=m.bus;
      r.insertCell().innerText=`${m.text} (${m.time})`;
      r.insertCell().innerText=m.status;
    });
  });
}
</script>
</body>
</html>

