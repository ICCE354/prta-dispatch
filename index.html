<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRTA Dispatch / MDT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.page{display:none;padding:20px}
input,select,textarea,button{
  width:100%;padding:8px;margin:6px 0;
  background:#020617;color:#e5e7eb;
  border:1px solid #1f2937;border-radius:6px
}
button{background:#2563eb;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #1f2937;padding:6px;text-align:center}
th{background:#020617}
.late{background:#7f1d1d}
.early{background:#1e3a8a}
.ontime{background:#064e3b}
</style>
</head>

<body>

<!-- LOGIN (FORCED VISIBLE) -->
<div id="loginPage" class="page" style="display:block">
  <h1>PRTA Secure Login</h1>

  <select id="role">
    <option value="driver">Driver</option>
    <option value="dispatcher">Dispatcher</option>
    <option value="supervisor">Supervisor</option>
  </select>

  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <input id="busInput" placeholder="Bus ID (drivers only)">

  <label><input type="checkbox" id="pt1"> Brakes OK</label><br>
  <label><input type="checkbox" id="pt2"> Doors OK</label><br>
  <label><input type="checkbox" id="pt3"> Lights OK</label><br><br>

  <button onclick="login()">Login</button>
</div>

<!-- DRIVER -->
<div id="driverPage" class="page">
  <h1>ğŸš Driver MDT</h1>
  <button onclick="logout()">Logout</button>
  <table id="driverTable"></table>
</div>

<!-- DISPATCHER -->
<div id="dispatcherPage" class="page" style="overflow-y:auto;max-height:100vh">

  <h1>ğŸ§‘â€ğŸ’» Dispatcher</h1>
  <button onclick="logout()">Logout</button>

  <!-- SCHEDULE BUILDER (FORCED VISIBLE) -->
  <div style="border:2px solid #2563eb;padding:12px;margin:15px 0">
    <h3>ğŸ“‹ Schedule Builder</h3>

    <input id="schDriver" placeholder="Driver Username (e.g. 3675)">
    <input id="schBus" placeholder="Bus ID">

    <textarea id="schPoints" rows="3"
      placeholder="Terminal 15:30 | MainSt 15:45 | Depot 16:00"></textarea>

    <button onclick="createSchedule()">Assign Schedule</button>
  </div>

  <!-- LIVE BOARD -->
  <h3>ğŸš¦ Live Board</h3>
  <table id="boardDispatcher"></table>

</div>

<!-- SUPERVISOR -->
<div id="supervisorPage" class="page">
  <h1>ğŸ§‘â€ğŸ’¼ Supervisor</h1>
  <button onclick="logout()">Logout</button>
  <table id="boardSupervisor"></table>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* AUDIO */
const departSound = new Audio("Timetodepart.wav");
let audioReady=false;
document.addEventListener("click",()=>audioReady=true,{once:true});

/* FIREBASE */
if(!firebase.apps.length){
  firebase.initializeApp({
    apiKey:"AIzaSyAQ0dtJowQk2aPV_laJNJoUZFJQLxEr9u0",
    authDomain:"prta-dispatch.firebaseapp.com",
    projectId:"prta-dispatch"
  });
}
const db=firebase.firestore();

/* USERS */
const users={
  dispatcher:{password:"admin",role:"dispatcher"},
  U11:{password:"BIGT",role:"supervisor"},
  "3675":{password:"SR",role:"driver"}
};

let currentUser={};

/* UI */
function show(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
}

/* LOGIN */
async function login(){
  if(!users[username.value] ||
     users[username.value].password!==password.value ||
     users[username.value].role!==role.value){
    alert("Invalid login");return;
  }

  if(role.value==="driver" &&
     (!(pt1.checked&&pt2.checked&&pt3.checked)||!busInput.value)){
    alert("Pre-trip required");return;
  }

  currentUser={username:username.value,role:role.value};

  if(role.value==="driver"){show("driverPage");loadDriver();}
  if(role.value==="dispatcher"){show("dispatcherPage");renderBoard("boardDispatcher");}
  if(role.value==="supervisor"){show("supervisorPage");renderBoard("boardSupervisor");}
}

/* LOGOUT â€” DELETE EVERYTHING */
async function logout(){
  if(currentUser.role==="driver"){
    const ref=db.collection("schedules").doc(currentUser.username).collection("trips");
    const snap=await ref.get();
    for(const d of snap.docs) await d.ref.delete();
    await db.collection("schedules").doc(currentUser.username).delete();
  }
  currentUser={};
  show("loginPage");
}

/* CREATE SCHEDULE */
async function createSchedule(){
  const points=schPoints.value.split("|").map(p=>{
    const [label,time]=p.trim().split(" ");
    return{label,sched:time,arrived:false,alerted:false};
  });

  await db.collection("schedules")
    .doc(schDriver.value)
    .collection("trips")
    .add({bus:schBus.value,points});

  schPoints.value="";
  renderBoard("boardDispatcher");
}

/* DRIVER VIEW */
async function loadDriver(){
  const t=driverTable;
  t.innerHTML="<tr><th>Stop</th><th>Time</th><th>Status</th></tr>";

  const snap=await db.collection("schedules")
    .doc(currentUser.username)
    .collection("trips").get();

  snap.forEach(doc=>{
    const trip=doc.data();
    trip.points.forEach((p,i)=>{
      const now=new Date();
      const [h,m]=p.sched.split(":").map(Number);
      const sched=new Date();sched.setHours(h,m,0,0);

      if(!p.arrived&&!p.alerted&&now>=sched&&audioReady){
        departSound.play().catch(()=>{});
        p.alerted=true;
        doc.ref.update({points:trip.points});
      }

      const r=t.insertRow();
      r.insertCell().innerText=p.label;
      r.insertCell().innerText=p.sched;

      if(p.arrived){
        r.insertCell().innerText=`${p.status} (${p.delta}m)`;
        r.className=p.status==="Late"?"late":p.status==="Early"?"early":"ontime";
      }else{
        r.insertCell().innerHTML=
          `<button onclick="arrive('${doc.id}',${i})">Arrived</button>`;
      }
    });
  });
}

/* ARRIVE */
async function arrive(id,i){
  const ref=db.collection("schedules")
    .doc(currentUser.username)
    .collection("trips").doc(id);
  const trip=(await ref.get()).data();

  const now=new Date();
  const [h,m]=trip.points[i].sched.split(":").map(Number);
  const sched=new Date();sched.setHours(h,m,0,0);
  const diff=Math.round((now-sched)/60000);

  let status="On Time";
  if(diff>=2)status="Late";
  if(diff<=-2)status="Early";

  trip.points[i]={...trip.points[i],arrived:true,status,delta:Math.abs(diff)};

  if(trip.points.every(p=>p.arrived)) await ref.delete();
  else await ref.update({points:trip.points});

  loadDriver();
  renderBoard("boardDispatcher");
  renderBoard("boardSupervisor");
}

/* BOARDS */
async function renderBoard(id){
  const t=document.getElementById(id);
  if(!t)return;
  t.innerHTML="<tr><th>Driver</th><th>Status</th></tr>";

  const snap=await db.collection("schedules").get();
  for(const d of snap.docs){
    const trips=await d.ref.collection("trips").get();
    trips.forEach(tr=>{
      const r=t.insertRow();
      r.insertCell().innerText=d.id;
      r.insertCell().innerText=
        tr.data().points.map(p=>{
          if(!p.arrived)return"âšª";
          if(p.status==="Late")return"ğŸ”´";
          if(p.status==="Early")return"ğŸ”µ";
          return"ğŸŸ¢";
        }).join(" ");
    });
  }
}

/* POLL */
setInterval(()=>{if(currentUser.role==="driver")loadDriver();},30000);
</script>
</body>
</html>
