<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PRTA Driver MDT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#020617;
  color:#e5e7eb;
}
.page{display:none;padding:20px}
button,input{
  width:100%;
  padding:14px;
  margin:10px 0;
  background:#020617;
  color:#e5e7eb;
  border:2px solid #1f2937;
  border-radius:10px;
  font-size:18px;
}
button{
  background:#1e3a8a;
  font-weight:bold;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #1f2937;
  padding:8px;
  text-align:center;
}
th{background:#020617}
.box{
  border:2px solid #2563eb;
  padding:12px;
  margin:12px 0;
}
#lateBanner{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:12px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
  display:none;
}
.late{background:#7f1d1d}
.warn{background:#92400e}
.ontime{background:#064e3b}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="page" style="display:block">
<h2>PRTA Driver Login</h2>
<input id="username" placeholder="Driver ID">
<input id="password" type="password" placeholder="Password">
<input id="busInput" placeholder="Bus ID">
<label><input type="checkbox" id="pt1"> Brakes</label>
<label><input type="checkbox" id="pt2"> Doors</label>
<label><input type="checkbox" id="pt3"> Lights</label>
<button onclick="login()">Login</button>
</div>

<!-- DRIVER HOME -->
<div id="driverHome" class="page">
<h2>Driver Home</h2>
<div class="grid">
  <button onclick="openSchedule()">ðŸ“‹ Schedule</button>
  <button onclick="openPassenger()">ðŸ‘¥ Passenger Count</button>
  <button onclick="openAnnouncements()">ðŸ“¢ Announcements</button>
  <button onclick="logout()">ðŸšª Log Out</button>
</div>
</div>

<!-- SCHEDULE -->
<div id="schedulePage" class="page">
<h2>Assigned Timepoints</h2>
<button onclick="goHome()">â¬… Home</button>
<table id="driverTable"></table>
</div>

<!-- PASSENGER COUNT -->
<div id="passengerPage" class="page">
<h2>Passenger Count</h2>

<div class="box">
<h3>Boarded</h3>
<button onclick="boarded++ ; updatePassenger()">+1</button>
<button onclick="boarded=Math.max(0,boarded-1); updatePassenger()">-1</button>
<p id="boardedCount">0</p>
</div>

<div class="box">
<h3>Alighted</h3>
<button onclick="alighted++ ; updatePassenger()">+1</button>
<button onclick="alighted=Math.max(0,alighted-1); updatePassenger()">-1</button>
<p id="alightedCount">0</p>
</div>

<div class="box">
<h3>Onboard</h3>
<p id="onboardCount">0</p>
</div>

<button onclick="sendPassenger()">ðŸ“¤ Send to Dispatch</button>
<button onclick="goHome()">â¬… Home</button>
</div>

<!-- ANNOUNCEMENTS -->
<div id="announcePage" class="page">
<h2>Announcements</h2>

<button>ðŸš¶ Please Move to Rear</button>
<button>ðŸŒ™ Night Safety Message</button>
<button>ðŸš« Do Not Talk to Operator</button>
<button>â™¿ Accessible Seating Reminder</button>

<button onclick="goHome()">â¬… Home</button>
</div>

<div id="lateBanner"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAQ0dtJowQk2aPV_laJNJoUZFJQLxEr9u0",
  authDomain:"prta-dispatch.firebaseapp.com",
  projectId:"prta-dispatch"
});
const db=firebase.firestore();

const users={
  "3675":{password:"SR"},
  "3804":{password:"ER"}
};

let currentUser={}, currentBus="";
let boarded=0, alighted=0;
let lateTimer=null;

function show(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
}

function login(){
  if(!users[username.value]||users[username.value].password!==password.value){
    alert("Invalid login"); return;
  }
  if(!busInput.value||!(pt1.checked&&pt2.checked&&pt3.checked)){
    alert("Pre-trip required"); return;
  }
  currentUser={username:username.value};
  currentBus=busInput.value;
  show("driverHome");
  listenDriver();
}

function logout(){
  clearInterval(lateTimer);
  boarded=0; alighted=0; updatePassenger();
  clearTrips();
  show("loginPage");
}

function goHome(){show("driverHome")}
function openSchedule(){show("schedulePage")}
function openPassenger(){show("passengerPage")}
function openAnnouncements(){show("announcePage")}

function updatePassenger(){
  boardedCount.innerText=boarded;
  alightedCount.innerText=alighted;
  onboardCount.innerText=Math.max(0,boarded-alighted);
}

async function sendPassenger(){
  await db.collection("passengerReports").add({
    driver:currentUser.username,
    bus:currentBus,
    boarded,
    alighted,
    onboard:Math.max(0,boarded-alighted),
    time:new Date().toLocaleString()
  });
  alert("Passenger count sent");
}

function listenDriver(){
  db.collection("schedules").doc(currentUser.username).collection("trips")
  .onSnapshot(snap=>{
    driverTable.innerHTML="<tr><th>Stop</th><th>Time</th><th>Status</th></tr>";
    snap.forEach(doc=>{
      const trip=doc.data();
      startLate(trip);
      trip.points.forEach((p,i)=>{
        const r=driverTable.insertRow();
        r.insertCell().innerText=p.label;
        r.insertCell().innerText=p.time;
        r.insertCell().innerHTML=p.arrived
          ?`${p.status} (${p.delta}m)`
          :`<button onclick="arrive('${doc.id}',${i})">Arrived</button>`;
      });
    });
  });
}

async function arrive(id,i){
  const ref=db.collection("schedules").doc(currentUser.username).collection("trips").doc(id);
  const trip=(await ref.get()).data();
  const now=new Date();
  const [h,m]=trip.points[i].time.split(":").map(Number);
  const sched=new Date(); sched.setHours(h,m,0,0);
  const diff=Math.round((now-sched)/60000);
  let status="On Time";
  if(diff>=2) status="Late";
  if(diff<=-2) status="Early";
  trip.points[i]={...trip.points[i],arrived:true,delta:Math.abs(diff),status};
  if(trip.points.every(p=>p.arrived)){
    boarded=0; alighted=0; updatePassenger();
    await ref.delete();
    lateBanner.style.display="none";
  } else {
    await ref.update({points:trip.points});
  }
}

function startLate(trip){
  clearInterval(lateTimer);
  lateTimer=setInterval(()=>{
    const next=trip.points.find(p=>!p.arrived);
    if(!next){lateBanner.style.display="none"; return;}
    const [h,m]=next.time.split(":").map(Number);
    const sched=new Date(); sched.setHours(h,m,0,0);
    const diff=Math.round((new Date()-sched)/60000);
    lateBanner.style.display="block";
    if(diff<=0){
      lateBanner.className="ontime";
      lateBanner.innerText="ON TIME";
    } else if(diff<3){
      lateBanner.className="warn";
      lateBanner.innerText=`LATE ${diff} MIN`;
    } else {
      lateBanner.className="late";
      lateBanner.innerText=`LATE ${diff} MIN`;
    }
  },60000);
}

async function clearTrips(){
  const ref=db.collection("schedules").doc(currentUser.username);
  const snap=await ref.collection("trips").get();
  snap.forEach(d=>d.ref.delete());
  await ref.delete();
}
</script>
</body>
</html>


